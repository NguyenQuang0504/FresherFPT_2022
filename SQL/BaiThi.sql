CREATE DATABASE BaiThiSQL
GO

CREATE TABLE NHANVIEN 
(
    MaNV CHAR(5) NOT NULL PRIMARY KEY,
    HoTen NVARCHAR(30) NOT NULL,
    CMND CHAR(11) NOT NULL,
    GioiTinh CHAR(3) NOT NULL,
    NgaySinh DATE NOT NULL,
    DiaChi NVARCHAR(50) NOT NULL,
    SoDienThoai CHAR(12) NOT NULL,
    MaPB CHAR(5) NOT NULL,
    FOREIGN KEY (MaPB) REFERENCES PHONGBAN(MaPB)
)

CREATE TABLE PHONGBAN
(
    MaPB CHAR(5) NOT NULL PRIMARY KEY,
    TenPB VARCHAR(50) NOT NULL
)

CREATE TABLE DUAN 
(
    MaDA CHAR(5) NOT NULL PRIMARY KEY,
    TenDA NVARCHAR(50) NOT NULL,
    MaPB CHAR(5) NOT NULL,
    MaTDA CHAR(5) NOT NULL,
    FOREIGN KEY(MaPB) REFERENCES PHONGBAN(MaPB),
    FOREIGN KEY(MaTDA) REFERENCES NHANVIEN(MaNV)
)

CREATE TABLE NGONNGU 
(
    MaNN CHAR(5) NOT NULL PRIMARY KEY,
    TenNN NVARCHAR(30) NOT NULL
)

CREATE TABLE VIECLAM 
(
    MaVL CHAR(5) NOT NULL PRIMARY KEY,
    TenVL NVARCHAR(50) NOT NULL,
    MaNN CHAR(5) NOT NULL,
    TongNgayCong INT NOT NULL,
    MaDA CHAR(5) NOT NULL,
    NgayBD DATE NOT NULL,
    NgayKT DATE NOT NULL,
    TrangThai VARCHAR(20),
    FOREIGN KEY(MaDA) REFERENCES DUAN(MaDA),
    FOREIGN KEY(MaNN) REFERENCES NGONNGU(MaNN)
)

CREATE TABLE DANGKYLAMTHEM 
(
    MaDK CHAR(5) NOT NULL PRIMARY KEY,
    MaNV CHAR(5) NOT NULL,
    MaVL CHAR(5) NOT NULL,
    SoNgayCong INT NOT NULL,
    GiaNgayCong MONEY NOT NULL
    FOREIGN KEY (MaNV) REFERENCES NHANVIEN(MaNV),
    FOREIGN KEY (MaVL) REFERENCES VIECLAM(MaVL)
)

INSERT NGONNGU VALUES 
('NN001', 'JAVA'),
('NN002', 'COBOL'),
('NN003', N'C#'),
('NN004', 'Biz Browser')

SELECT * FROM NGONNGU

INSERT PHONGBAN VALUES 
('PB001', N'R&D'),
('PB002', N'Phat trien'),
('PB003', N'Thuong mai dien tu'),
('PB004', N'Hanh Chinh'),
('PB005', N'Ke toan'),
('PB006', N'Nhan su')

SELECT * FROM PHONGBAN

INSERT NHANVIEN VALUES 
('NV001', 'Nguyen Van Hung', '1914235876', 'Nam', '19871105', '76 CMT8', '0907657654', 'PB001'),
('NV002', 'Nguyen Van Son', '1937687654', 'Nam', '19780615', '25 Ha Huy Tap', '0988765432', 'PB002'),
('NV003', 'Tran Thi Phuong', '1974654328', 'Nu', '19780524', '17 Hai Phong', '0915976546', 'PB003'),
('NV004', 'Le Phan Thi', '1978653295', 'Nu', '19800504', '5 Nam Ky Khoi Nghia', '0987643342', 'PB004'),
('NV005', 'Bui Viet Linh', '2018076543', 'Nam', '19751010', '257 Nguyen Tri Phuong', '0963456543', 'PB005'),
('NV006', 'Truong Van Vinh', '2018976789', 'Nam', '19901014', '30 Phan Chu Trinh', '0987657865', 'PB006')

INSERT DUAN VALUES 
('DA001', 'CODEEX', 'PB001', 'NV005'),
('DA002', 'SKY', 'PB002', 'NV006')

INSERT VIECLAM VALUES 
('VL001', 'Support open du an', 'NN001', 3, 'DA001', '20201209', '20201215', 'Open'),
('VL002', 'Code function', 'NN002', 4, 'DA002', '20210404', '20210420', 'Hired'),
('VL003', 'Test function', 'NN003', 20, 'DA001', '20210617', '20210630', 'Closed'),
('VL004', 'Design function', 'NN004', 20, 'DA002', '20200212', '20201225', 'Open')

INSERT DANGKYLAMTHEM VALUES
('DK001', 'NV001', 'VL001', 3, 700000),
('DK002', 'NV002', 'VL002', 4, 650000),
('DK003', 'NV003', 'VL003', 10, 800000),
('DK004', 'NV004', 'VL004', 15, 800000)

-- Cau 3
SELECT * FROM NHANVIEN WHERE GioiTinh = 'Nu' AND HoTen LIKE 'Tran %' AND DATEDIFF(YEAR, NgaySinh, GETDATE()) BETWEEN 25 AND 35

--Cau 4 
SELECT v.MaVL, v.TenVL, n.TenNN, v.TongNgayCong, v.NgayBD, v.NgayKT, v.TrangThai FROM VIECLAM v INNER JOIN NGONNGU n ON v.MaNN = n.MaNN

--Cau 5
--C1
SELECT NHANVIEN.MaNV, NHANVIEN.HoTen, NHANVIEN.GioiTinh, PHONGBAN.TenPB FROM NHANVIEN INNER JOIN PHONGBAN ON NHANVIEN.MaPB = PHONGBAN.MaPB WHERE NHANVIEN.MaNV NOT IN(
SELECT NHANVIEN.MaNV FROM NHANVIEN INNER JOIN DANGKYLAMTHEM ON NHANVIEN.MaNV = DANGKYLAMTHEM.MaNV
) 
--C2
SELECT NHANVIEN.MaNV, NHANVIEN.HoTen, NHANVIEN.GioiTinh, PHONGBAN.TenPB FROM NHANVIEN LEFT JOIN DANGKYLAMTHEM ON NHANVIEN.MaNV = DANGKYLAMTHEM.MaNV INNER JOIN PHONGBAN ON PHONGBAN.MaPB = NHANVIEN.MaPB WHERE DANGKYLAMTHEM.MaNV IS NULL


--Caau 6 
SELECT TOP 1 WITH TIES NHANVIEN.MaNV, NHANVIEN.HoTen ,SUM(SoNgayCong)*GiaNgayCong FROM NHANVIEN INNER JOIN DANGKYLAMTHEM ON NHANVIEN.MaNV = DANGKYLAMTHEM.MaNV GROUP BY NHANVIEN.MaNV, HoTen, GiaNgayCong ORDER BY SUM(SoNgayCong)*GiaNgayCong DESC

--Cau 7
SELECT PHONGBAN.MaPB, PHONGBAN.TenPB, TongNgayCong FROM PHONGBAN INNER JOIN DUAN ON PHONGBAN.MaPB = DUAN.MaPB INNER JOIN VIECLAM ON DUAN.MaDA = VIECLAM.MaDA WHERE YEAR(NgayBD) = '2020' AND YEAR(NgayKT) = '2020'

--Cau 8 
SELECT NHANVIEN.MaNV, HoTen, DiaChi, SoNgayCong, TenPB, DANGKYLAMTHEM.SoNgayCong*DANGKYLAMTHEM.GiaNgayCong FROM NHANVIEN INNER JOIN PHONGBAN ON NHANVIEN.MaPB = PHONGBAN.MaPB LEFT JOIN DANGKYLAMTHEM ON NHANVIEN.MaNV = DANGKYLAMTHEM.MaNV 

--Cau 9
SELECT NHANVIEN.MaNV, NHANVIEN.HoTen, NHANVIEN.DiaChi, NHANVIEN.SoDienThoai FROM NHANVIEN INNER JOIN DANGKYLAMTHEM ON NHANVIEN.MaNV = DANGKYLAMTHEM.MaNV WHERE NHANVIEN.MaNV IN (
SELECT NHANVIEN.MaNV FROM NHANVIEN INNER JOIN DANGKYLAMTHEM ON NHANVIEN.MaNV = DANGKYLAMTHEM.MaNV GROUP BY NHANVIEN.MaNV HAVING COUNT(NHANVIEN.MaNV) > =2
) AND DANGKYLAMTHEM.GiaNgayCong * DANGKYLAMTHEM.SoNgayCong > 9000000


-- Cau 10
SELECT * FROM NHANVIEN INNER JOIN PHONGBAN ON NHANVIEN.MaPB = PHONGBAN.MaPB WHERE PHONGBAN.TenPB = 'Phat trien' AND NHANVIEN.MaNV IN (
SELECT NHANVIEN.MaNV FROM NHANVIEN INNER JOIN DANGKYLAMTHEM ON NHANVIEN.MaNV = DANGKYLAMTHEM.MaNV INNER JOIN VIECLAM ON VIECLAM.MaVL = DANGKYLAMTHEM.MaVL INNER JOIN NGONNGU ON VIECLAM.MaNN = NGONNGU.MaNN WHERE NGONNGU.TenNN != N'JAVA' AND NGONNGU.TenNN != N'COBOL'
)
--Cau 11
UPDATE VIECLAM SET TrangThai = 'Closed' WHERE DATEDIFF(DAY, GETDATE(), NgayKT) < 0

-- Cau 13
SELECT VIECLAM.MaVL, VIECLAM.TenVL, VIECLAM.TongNgayCong, VIECLAM.NgayBD, VIECLAM.NgayKT FROM VIECLAM INNER JOIN DANGKYLAMTHEM ON VIECLAM.MaVL = DANGKYLAMTHEM.MaVL



